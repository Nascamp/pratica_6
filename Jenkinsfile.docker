pipeline {
    agent any
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
    }
    
    environment {
        JAVA_HOME = tool 'Java17'
        MAVEN_HOME = tool 'Maven3.9'
        PATH = "${MAVEN_HOME}/bin:${JAVA_HOME}/bin:${PATH}"
        PROJECT_NAME = 'Pratica-4-DevOps'
        WORKSPACE_DIR = "${WORKSPACE}/pratica_6"
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_IMAGE_NAME = 'nascamp/pratica-6'
        DOCKER_IMAGE_TAG = "${BUILD_NUMBER}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ðŸ”„ Clonando repositÃ³rio para Docker Build...'
                checkout scm
                script {
                    GIT_COMMIT = sh(script: 'git rev-parse HEAD', returnStdout: true).trim()
                    GIT_BRANCH = sh(script: 'git rev-parse --abbrev-ref HEAD', returnStdout: true).trim()
                    echo "âœ… Branch: ${GIT_BRANCH}"
                    echo "âœ… Commit: ${GIT_COMMIT}"
                }
            }
        }
        
        stage('Build Project') {
            steps {
                echo 'ðŸ”¨ Compilando o projeto...'
                dir("${WORKSPACE_DIR}") {
                    sh '''
                        echo "=== VersÃ£o do Maven ==="
                        mvn --version
                        echo ""
                        echo "=== Compilando ==="
                        mvn clean compile -DskipTests
                    '''
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                echo 'ðŸ§ª Executando testes...'
                dir("${WORKSPACE_DIR}") {
                    sh '''
                        echo "=== Iniciando testes ==="
                        mvn clean test -DskipITs
                        echo "=== Testes completados ==="
                    '''
                }
            }
        }
        
        stage('Build Package') {
            steps {
                echo 'ðŸ“¦ Empacotando aplicaÃ§Ã£o...'
                dir("${WORKSPACE_DIR}") {
                    sh '''
                        echo "=== Buildando JAR ==="
                        mvn package -DskipTests -q
                        echo "=== JAR criado ==="
                        ls -lh target/*.jar
                    '''
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo 'ðŸ³ Construindo imagem Docker...'
                dir("${WORKSPACE_DIR}") {
                    script {
                        sh '''
                            echo "=== Verificando Dockerfile ==="
                            if [ -f Dockerfile ]; then
                                echo "âœ… Dockerfile encontrado"
                                docker build -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} .
                                docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} ${DOCKER_IMAGE_NAME}:latest
                                echo "âœ… Imagem Docker construÃ­da com sucesso"
                                echo "ðŸ“‹ Imagens criadas:"
                                docker images | grep ${DOCKER_IMAGE_NAME}
                            else
                                echo "âš ï¸ Dockerfile nÃ£o encontrado no repositÃ³rio"
                                echo "ðŸ“ Criando Dockerfile padrÃ£o..."
                                cat > Dockerfile << 'EOF'
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java","-jar","app.jar"]
EOF
                                echo "âœ… Dockerfile criado"
                                docker build -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} .
                                docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} ${DOCKER_IMAGE_NAME}:latest
                                echo "âœ… Imagem Docker construÃ­da com sucesso"
                            fi
                        '''
                    }
                }
            }
        }
        
        stage('Push to Registry') {
            when {
                branch 'main'
            }
            steps {
                echo 'ðŸ“¤ Enviando imagem Docker para o registro...'
                script {
                    sh '''
                        echo "=== Fazendo login no Docker Registry ==="
                        echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
                        
                        echo "=== Fazendo push da imagem ==="
                        docker push ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}
                        docker push ${DOCKER_IMAGE_NAME}:latest
                        
                        echo "âœ… Imagens enviadas com sucesso"
                    '''
                }
            }
        }
        
        stage('Verify Docker Image') {
            steps {
                echo 'âœ”ï¸ Verificando imagem Docker...'
                sh '''
                    echo "=== InformaÃ§Ãµes da Imagem ==="
                    docker inspect ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} || echo "âš ï¸ Imagem nÃ£o encontrada"
                    echo "=== Imagens disponÃ­veis ==="
                    docker images | grep ${DOCKER_IMAGE_NAME} || echo "âš ï¸ Nenhuma imagem encontrada"
                '''
            }
        }
        
        stage('Archive Artifacts') {
            steps {
                echo 'ðŸ’¾ Arquivando artefatos...'
                dir("${WORKSPACE_DIR}") {
                    archiveArtifacts artifacts: 'target/*.jar,Dockerfile', 
                                     fingerprint: true,
                                     allowEmptyArchive: false
                }
            }
        }
    }
    
    post {
        always {
            echo 'ðŸ§¹ Limpando espaÃ§o em disco...'
            sh 'docker rmi ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} || true'
        }
        success {
            echo 'âœ… Pipeline Docker executado com sucesso!'
        }
        failure {
            echo 'âŒ Pipeline Docker falhou!'
        }
    }
}
