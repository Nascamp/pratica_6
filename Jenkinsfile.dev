pipeline {
    agent any
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '15'))
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
    }
    
    environment {
        JAVA_HOME = tool 'Java17'
        MAVEN_HOME = tool 'Maven3.9'
        PATH = "${MAVEN_HOME}/bin:${JAVA_HOME}/bin:${PATH}"
        PROJECT_NAME = 'Pratica-4-DevOps'
        WORKSPACE_DIR = "${WORKSPACE}/pratica_6"
        DOCKER_IMAGE_NAME = 'nascamp/pratica-6-dev'
        DOCKER_IMAGE_TAG = "${BUILD_NUMBER}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ðŸ”„ Clonando repositÃ³rio do branch dev...'
                checkout scm
                script {
                    GIT_COMMIT = sh(script: 'git rev-parse HEAD', returnStdout: true).trim()
                    GIT_BRANCH = sh(script: 'git rev-parse --abbrev-ref HEAD', returnStdout: true).trim()
                    echo "âœ… Branch: ${GIT_BRANCH}"
                    echo "âœ… Commit: ${GIT_COMMIT}"
                }
            }
        }
        
        stage('Setup Environment') {
            steps {
                echo 'âš™ï¸ Configurando ambiente de desenvolvimento...'
                sh '''
                    echo "=== Java Version ==="
                    java -version
                    echo ""
                    echo "=== Maven Version ==="
                    mvn --version
                    echo ""
                    echo "=== Docker Version ==="
                    docker --version
                '''
            }
        }
        
        stage('Clean & Compile') {
            steps {
                echo 'ðŸ”¨ Compilando o projeto em DEV...'
                dir("${WORKSPACE_DIR}") {
                    sh '''
                        echo "=== Limpando builds anteriores ==="
                        mvn clean
                        echo ""
                        echo "=== Compilando ==="
                        mvn compile -DskipTests
                        echo "âœ… CompilaÃ§Ã£o concluÃ­da"
                    '''
                }
            }
        }
        
        stage('Unit Tests') {
            steps {
                echo 'ðŸ§ª Executando testes unitÃ¡rios...'
                dir("${WORKSPACE_DIR}") {
                    sh '''
                        echo "=== Iniciando testes unitÃ¡rios ==="
                        mvn test -DskipITs
                        echo "âœ… Testes concluÃ­dos"
                    '''
                }
            }
        }
        
        stage('Code Analysis') {
            steps {
                echo 'ðŸ“Š Analisando qualidade de cÃ³digo...'
                dir("${WORKSPACE_DIR}") {
                    sh '''
                        echo "=== AnÃ¡lise de CÃ³digo ==="
                        mvn compile -q -DskipTests
                        echo "âœ… AnÃ¡lise concluÃ­da"
                    '''
                }
            }
        }
        
        stage('Build Package') {
            steps {
                echo 'ðŸ“¦ Empacotando aplicaÃ§Ã£o...'
                dir("${WORKSPACE_DIR}") {
                    sh '''
                        echo "=== Buildando JAR ==="
                        mvn package -DskipTests
                        echo "=== JAR criado ==="
                        ls -lh target/*.jar || echo "Nenhum JAR encontrado"
                    '''
                }
            }
        }
        
        stage('Build Docker Image - DEV') {
            steps {
                echo 'ðŸ³ Construindo imagem Docker para DEV...'
                dir("${WORKSPACE_DIR}") {
                    script {
                        sh '''
                            echo "=== Construindo Docker Image DEV ==="
                            if [ -f Dockerfile ]; then
                                docker build -f Dockerfile -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} .
                                docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} ${DOCKER_IMAGE_NAME}:dev
                            else
                                echo "ðŸ“ Criando Dockerfile padrÃ£o para DEV..."
                                cat > Dockerfile.dev << 'EOF'
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY target/*.jar app.jar
EXPOSE 8080
ENV ENVIRONMENT=development
ENTRYPOINT ["java","-Dspring.profiles.active=dev","-jar","app.jar"]
EOF
                                docker build -f Dockerfile.dev -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} .
                                docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} ${DOCKER_IMAGE_NAME}:dev
                            fi
                            echo "âœ… Imagem Docker DEV construÃ­da"
                        '''
                    }
                }
            }
        }
        
        stage('Run Application Tests') {
            steps {
                echo 'ðŸš€ Testando aplicaÃ§Ã£o em container...'
                script {
                    sh '''
                        echo "=== Testando container ==="
                        docker run --rm ${DOCKER_IMAGE_NAME}:dev java -version
                        echo "âœ… Testes de container concluÃ­dos"
                    '''
                }
            }
        }
        
        stage('Archive Results') {
            steps {
                echo 'ðŸ’¾ Arquivando resultados...'
                dir("${WORKSPACE_DIR}") {
                    archiveArtifacts artifacts: 'target/**.jar,target/surefire-reports/**', 
                                     allowEmptyArchive: true,
                                     fingerprint: true
                }
            }
        }
        
        stage('Publish Test Results') {
            steps {
                echo 'ðŸ“ˆ Publicando resultados dos testes...'
                dir("${WORKSPACE_DIR}") {
                    junit 'target/surefire-reports/*.xml'
                }
            }
        }
    }
    
    post {
        always {
            echo 'ðŸ§¹ Finalizando pipeline...'
            sh '''
                echo "=== InformaÃ§Ãµes finais ==="
                docker images | grep ${DOCKER_IMAGE_NAME} || echo "âš ï¸ Nenhuma imagem DEV encontrada"
            '''
        }
        success {
            echo 'âœ… Pipeline DEV executado com sucesso!'
        }
        failure {
            echo 'âŒ Pipeline DEV falhou!'
        }
        unstable {
            echo 'âš ï¸ Pipeline DEV instÃ¡vel!'
        }
    }
}
